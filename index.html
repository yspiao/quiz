<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUIZ // SYSTEM v10.0</title>
    <style>
        /* =========================================
           CORE THEME: NOIR & INTERACTIVE
           ========================================= */
        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --border: #1f1f1f;
            
            --text-main: #e5e5e5;
            --text-dim: #666;
            
            --accent: #d2a8ff; 
            --edit: #e3b341;
            
            --cursor-bg: #e5e5e5;
            --cursor-text: #000000;
            
            --font: "JetBrains Mono", "Menlo", "Consolas", monospace;
        }

        * { box-sizing: border-box; cursor: text; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg); 
            color: var(--text-main);
            font-family: var(--font); 
            font-size: 13px; 
            line-height: 1.6;
            overflow: hidden;
        }

        /* 1. Header */
        #header {
            position: fixed; top: 0; left: 0; width: 100%; height: 40px;
            background: rgba(0,0,0,0.9);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 20px;
            z-index: 100;
        }
        .logo-text { font-weight: 800; letter-spacing: 2px; color: var(--text-main); }

        /* 2. Main Terminal */
        #terminal {
            position: absolute; top: 40px; bottom: 0; left: 0; width: 100%;
            padding: 20px 20px 80px 20px;
            overflow-y: auto; z-index: 10;
        }
        .line { margin-bottom: 6px; white-space: pre-wrap; word-break: break-all; }
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 16px;
            margin: 8px 0 16px 0;
        }
        .card-header {
            font-size: 11px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 10px;
            border-bottom: 1px solid var(--border); padding-bottom: 5px;
            display: flex; justify-content: space-between;
        }

        /* 3. MANAGER UI */
        #manager-layer {
            position: absolute; top: 40px; bottom: 80px; left: 0; width: 100%;
            background: var(--bg);
            z-index: 50; display: none; overflow-y: auto; padding: 10px 0;
        }
        .list-row { padding: 4px 20px; color: var(--text-dim); cursor: pointer; display: flex; justify-content: space-between; }
        .list-row:hover { background: rgba(255,255,255,0.05); }
        .list-row.selected { background-color: var(--cursor-bg); color: var(--cursor-text); }
        .list-row.selected .c-dim, .list-row.selected .tag { color: #333 !important; }
        .list-content { white-space: pre; overflow: hidden; text-overflow: ellipsis; }

        /* 4. SNAKE GAME UI (New) */
        .snake-grid {
            display: grid;
            grid-template-columns: repeat(40, 1fr); /* 40 cols */
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
            width: fit-content;
            margin: 0 auto;
        }
        .s-cell {
            width: 12px; height: 12px;
            background: var(--bg);
        }
        .s-snake { background: var(--text-main); }
        .s-head  { background: var(--edit); }
        .s-food  { background: var(--accent); box-shadow: 0 0 5px var(--accent); }
        .s-dead  { background: var(--error); }

        /* 5. Input Area */
        #input-wrapper {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 16px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
            z-index: 200;
            display: flex; align-items: center;
            font-family: var(--font);
            font-size: 14px;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        #input-wrapper.editing { border-color: var(--edit); }

        #cmd-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; z-index: 2;
            padding: 10px 16px;
            font-family: inherit; font-size: inherit;
            caret-color: transparent;
            color: transparent;
        }

        #input-display {
            position: relative; z-index: 1;
            white-space: pre;
            pointer-events: none;
            display: flex;
            align-items: center;
            color: var(--text-main);
            width: 100%;
        }

        .cursor-block {
            display: inline-block;
            width: 9px; height: 1.2em;
            background: var(--accent);
            animation: blink 1s infinite;
            margin: 0 1px;
            vertical-align: text-bottom;
            position: relative; top: 1px;
        }
        .cursor-block.edit-mode { background: var(--edit); }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Utils */
        .c-dim { color: var(--text-dim); }
        .c-accent { color: var(--accent); }
        .c-success { color: #3fb950; }
        .c-error { color: #f85149; }
        .tag { margin-left:8px; opacity:0.7; font-size:11px; }
        .heatmap-row { display: flex; gap: 3px; }
        .heat-cell { width:8px; height:8px; background:#222; border-radius:1px; }
        .heat-on { background: var(--accent); }
    </style>
</head>
<body>

<div id="header">
    <div id="quiz-logo" class="logo-text">....</div>
    <div style="flex:1"></div>
    <div id="status-bar" class="c-dim" style="font-size:11px;"></div>
</div>

<div id="terminal">
    <div id="output"></div>
</div>

<div id="manager-layer"></div>
<input type="file" id="file-loader" style="display:none" accept=".json">

<div id="input-wrapper">
    <input type="text" id="cmd-input" spellcheck="false" autocomplete="off">
    <div id="input-display">
        <span id="prompt-symbol" style="color:var(--text-dim); margin-right:10px">‚ùØ</span>
        <span id="mirror-left"></span><span id="cursor" class="cursor-block"></span><span id="mirror-right"></span>
    </div>
</div>

<script>
/**
 * QUIZ SYSTEM v10.0 // SNAKE GAME INTEGRATION
 * Feature: Added Snake Game Mode without affecting core systems
 */

const STORAGE_KEY = 'quiz_db_v9';
const ACTIVITY_KEY = 'quiz_act_v1';

const Database = {
    items: [], activity: {}, 
    load: function() {
        const d = localStorage.getItem(STORAGE_KEY);
        const a = localStorage.getItem(ACTIVITY_KEY);
        if (d) {
            this.items = JSON.parse(d);
            this.items.forEach(i => { if(!i.streak) i.streak = 0; if(!i.tags) i.tags = []; });
        }
        if (a) this.activity = JSON.parse(a);
    },
    save: function() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(this.items));
        localStorage.setItem(ACTIVITY_KEY, JSON.stringify(this.activity));
    },
    logActivity: function() {
        const k = new Date().toISOString().split('T')[0];
        this.activity[k] = (this.activity[k]||0) + 1;
        this.save();
    },
    getHeatmap: function() {
        const res = [];
        for(let i=4; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate()-i);
            const k = d.toISOString().split('T')[0];
            res.push(this.activity[k]||0);
        }
        return res;
    }
};

const State = {
    mode: 'SHELL', // SHELL, QUIZ, BLITZ, MANAGE, EDITING, SNAKE
    manageIndex: 0, editTargetIndex: null,
    quizPool: [], currentItem: null, answerRaw: null, 
    blitzScore: 0, blitzEnd: 0, blitzTimer: null,
    
    // Snake State
    snake: [], food: null, direction: 'RIGHT', nextDirection: 'RIGHT', snakeTimer: null, snakeScore: 0
};

const Sys = {
    out: document.getElementById('output'),
    mgr: document.getElementById('manager-layer'),
    inputWrap: document.getElementById('input-wrapper'),
    input: document.getElementById('cmd-input'),
    mirrorLeft: document.getElementById('mirror-left'),
    mirrorRight: document.getElementById('mirror-right'),
    cursor: document.getElementById('cursor'),
    logo: document.getElementById('quiz-logo'),
    statusBar: document.getElementById('status-bar'),
    fileLoader: document.getElementById('file-loader'),

    animateText: (el, txt) => {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ#%";
        let i = 0;
        const t = setInterval(() => {
            el.innerText = txt.split('').map((c,j) => j<i ? c : chars[Math.floor(Math.random()*chars.length)]).join('');
            if(i++ > txt.length) clearInterval(t);
        }, 30);
    },

    print: (html, type='line') => {
        const div = document.createElement('div');
        div.className = type==='card' ? 'card' : 'line';
        div.innerHTML = html;
        Sys.out.appendChild(div);
        Sys.out.scrollTop = Sys.out.scrollHeight;
    },

    printCard: (head, body) => Sys.print(`<div class="card-header">${head}</div><div>${body}</div>`, 'card'),

    updateStatus: () => {
        const xp = Database.items.reduce((a,b)=>a+(b.lvl||0), 0);
        const heat = Database.getHeatmap().map(v=>`<div class="heat-cell ${v>0?'heat-on':''}"></div>`).join('');
        Sys.statusBar.innerHTML = `<div style="display:flex; gap:10px; align-items:center;"><span>${Database.items.length} ITEMS</span> <span>${xp} XP</span> <div class="heatmap-row">${heat}</div></div>`;
    },

    syncCursor: () => {
        const val = Sys.input.value;
        const pos = Sys.input.selectionStart;
        const left = val.substring(0, pos);
        const right = val.substring(pos);
        Sys.mirrorLeft.textContent = left.replace(/ /g, '\u00a0');
        Sys.mirrorRight.textContent = right.replace(/ /g, '\u00a0');
    },

    boot: async () => {
        Sys.animateText(Sys.logo, "QUIZ");
        Database.load();
        await new Promise(r => setTimeout(r, 500));
        Sys.inputWrap.style.opacity = 1;
        Sys.input.focus();
        Sys.updateStatus();
        Sys.print("System Ready. Type <span class='c-accent'>help</span> for commands.", 'line');
    },

    exportFile: () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(Database.items, null, 2));
        const dl = document.createElement('a');
        dl.setAttribute("href", dataStr);
        dl.setAttribute("download", `quiz_backup_${new Date().toISOString().split('T')[0]}.json`);
        document.body.appendChild(dl); dl.click(); dl.remove();
        Sys.print("‚úî Export downloaded.", "c-success");
    },

    importFile: () => Sys.fileLoader.click(),

    exec: async (raw) => {
        const val = raw.trim();
        if(!val) return;

        if (State.mode === 'EDITING') { Sys.finishEdit(val); return; }
        if (State.mode === 'QUIZ' || State.mode === 'BLITZ') {
            if(['exit','quit','esc'].includes(val.toLowerCase())) { Sys.exitGame(); return; }
            Sys.checkAnswer(val);
            return;
        }
        if (State.mode === 'SNAKE') return; // Should be handled by key listener, but safe check

        Sys.print(`<span class="c-dim">‚ùØ</span> ${val}`);
        
        if (val.startsWith('+')) { Sys.addItem(val.substring(1)); return; }

        const [cmd, ...args] = val.split(' ');
        const argStr = args.join(' ');

        switch(cmd.toLowerCase()) {
            case 'list': case 'ls': case 'manage': Sys.enterManage(); break;
            case 'quiz': Sys.startQuiz(argStr); break;
            case 'blitz': Sys.startBlitz(); break;
            case 'snake': Sys.startSnake(); break; // New Command
            case 'help': 
                Sys.printCard("HELP", `
                    <span class="c-accent">list</span> : Manage (Edit/Del)<br>
                    <span class="c-accent">+ txt</span> : Quick Add<br>
                    <span class="c-accent">quiz</span> : Training<br>
                    <span class="c-accent">snake</span> : Play Game<br>
                    <span class="c-accent">export</span> : Backup
                `);
                break;
            case 'export': Sys.exportFile(); break;
            case 'import': Sys.importFile(); break;
            case 'clear': Sys.out.innerHTML=''; break;
            default: Sys.print("Unknown command.", "c-error");
        }
    },

    addItem: (str) => {
        const tagRegex = /#(\w+)/g;
        const tags = (str.match(tagRegex)||[]).map(t=>t.substring(1));
        const clean = str.replace(tagRegex,'').trim();
        if(clean.includes('::')) {
            const [q,a] = clean.split('::').map(s=>s.trim());
            if(q&&a) Database.items.push({type:'vocab', q, a, tags, lvl:0, streak:0});
        } else {
            Database.items.push({type:'sentence', text:clean, tags, lvl:0, streak:0});
        }
        Database.logActivity();
        Sys.print("‚úî Saved.", "c-success");
        Sys.updateStatus();
    },

    // --- MANAGER MODE ---
    enterManage: () => {
        if(Database.items.length === 0) { Sys.print("Database empty.", "c-error"); return; }
        State.mode = 'MANAGE';
        State.manageIndex = 0;
        Sys.out.style.opacity = '0.1';
        Sys.mgr.style.display = 'block';
        Sys.input.blur(); Sys.input.value = ''; Sys.syncCursor(); Sys.input.disabled = true; 
        document.getElementById('input-display').style.opacity = 0.5;
        Sys.renderManage();
    },

    renderManage: () => {
        Sys.mgr.innerHTML = '';
        const header = document.createElement('div');
        header.style.padding = '0 20px 10px 20px';
        header.style.color = 'var(--accent)';
        header.innerText = "MANAGER // [Arrow] Move, [Enter] Edit, [Bksp] Del, [ESC] Back";
        Sys.mgr.appendChild(header);
        Database.items.forEach((item, i) => {
            const row = document.createElement('div');
            row.className = 'list-row ' + (i === State.manageIndex ? 'selected' : '');
            row.onclick = () => { State.manageIndex = i; Sys.renderManage(); };
            let txt = item.type === 'vocab' ? `${item.q} :: ${item.a}` : item.text;
            let tags = item.tags.map(t=>`#${t}`).join(' ');
            row.innerHTML = `<div class="list-content">${txt} <span class="tag">${tags}</span></div><div class="c-dim" style="font-size:10px">L${item.lvl}</div>`;
            Sys.mgr.appendChild(row);
        });
        const sel = Sys.mgr.children[State.manageIndex + 1];
        if(sel) sel.scrollIntoView({block:'nearest'});
    },

    exitManage: () => {
        State.mode = 'SHELL';
        Sys.mgr.style.display = 'none';
        Sys.out.style.opacity = '1';
        Sys.input.disabled = false;
        document.getElementById('input-display').style.opacity = 1;
        Sys.input.focus();
    },

    // --- EDITING ---
    enterEditFromManage: () => {
        State.mode = 'EDITING';
        State.editTargetIndex = State.manageIndex;
        const item = Database.items[State.manageIndex];
        let str = item.type==='vocab' ? `${item.q} :: ${item.a}` : item.text;
        if(item.tags.length) str += " " + item.tags.map(t=>`#${t}`).join(' ');
        Sys.input.disabled = false;
        document.getElementById('input-display').style.opacity = 1;
        Sys.input.value = str;
        Sys.input.focus();
        setTimeout(() => { Sys.syncCursor(); }, 0);
        Sys.cursor.classList.add('edit-mode');
        Sys.inputWrap.classList.add('editing');
    },

    finishEdit: (val) => {
        if(!val) { Sys.returnToManageNav(); return; }
        const item = Database.items[State.editTargetIndex];
        const tagRegex = /#(\w+)/g;
        const tags = (val.match(tagRegex)||[]).map(t=>t.substring(1));
        const clean = val.replace(tagRegex,'').trim();
        if(clean.includes('::')) {
            const [q,a] = clean.split('::').map(s=>s.trim());
            item.type = 'vocab'; item.q = q; item.a = a;
        } else { item.type = 'sentence'; item.text = clean; }
        item.tags = tags;
        Database.save();
        Sys.returnToManageNav();
    },

    returnToManageNav: () => {
        State.mode = 'MANAGE';
        Sys.input.value = '';
        Sys.syncCursor();
        Sys.input.disabled = true;
        Sys.input.blur(); 
        document.getElementById('input-display').style.opacity = 0.5;
        Sys.cursor.classList.remove('edit-mode');
        Sys.inputWrap.classList.remove('editing');
        Sys.renderManage();
    },

    // --- SNAKE GAME LOGIC ---
    startSnake: () => {
        State.mode = 'SNAKE';
        State.snake = [{x: 20, y: 10}, {x: 19, y: 10}, {x: 18, y: 10}];
        State.direction = 'RIGHT';
        State.nextDirection = 'RIGHT';
        State.snakeScore = 0;
        
        // Hide input to focus on game
        Sys.inputWrap.style.opacity = 0.1; 
        Sys.input.blur();
        
        Sys.out.innerHTML = ''; // Clear screen for game board
        Sys.spawnFood();
        Sys.renderSnakeBoard();
        
        // Game Loop
        State.snakeTimer = setInterval(Sys.tickSnake, 80);
    },

    spawnFood: () => {
        let x, y, collision;
        do {
            x = Math.floor(Math.random() * 40);
            y = Math.floor(Math.random() * 20);
            collision = State.snake.some(s => s.x === x && s.y === y);
        } while (collision);
        State.food = {x, y};
    },

    tickSnake: () => {
        State.direction = State.nextDirection;
        const head = {...State.snake[0]};
        
        if (State.direction === 'UP') head.y--;
        if (State.direction === 'DOWN') head.y++;
        if (State.direction === 'LEFT') head.x--;
        if (State.direction === 'RIGHT') head.x++;
        
        // Wall Collision
        if (head.x < 0 || head.x >= 40 || head.y < 0 || head.y >= 20) {
            Sys.endSnake();
            return;
        }
        
        // Self Collision
        if (State.snake.some(s => s.x === head.x && s.y === head.y)) {
            Sys.endSnake();
            return;
        }
        
        State.snake.unshift(head);
        
        // Eat Food
        if (head.x === State.food.x && head.y === State.food.y) {
            State.snakeScore += 10;
            Sys.spawnFood();
        } else {
            State.snake.pop();
        }
        
        Sys.renderSnakeBoard();
    },

    renderSnakeBoard: () => {
        let html = `<div style="text-align:center; margin-bottom:10px;">SCORE: <span class="c-accent">${State.snakeScore}</span> <span class="c-dim">(Arrows to Move, ESC to Exit)</span></div>`;
        html += '<div class="snake-grid" style="grid-template-rows: repeat(20, 1fr);">';
        
        // Draw grid
        // This is a naive render, optimal for small grids. For larger, use canvas.
        // We render linear cells 40*20 = 800 cells.
        const board = new Array(800).fill(0); // 0 empty, 1 snake, 2 head, 3 food
        
        State.snake.forEach((s, i) => {
            const idx = s.y * 40 + s.x;
            if(idx >= 0 && idx < 800) board[idx] = i === 0 ? 2 : 1;
        });
        const fIdx = State.food.y * 40 + State.food.x;
        board[fIdx] = 3;
        
        board.forEach(cell => {
            let cls = 's-cell';
            if (cell === 1) cls += ' s-snake';
            if (cell === 2) cls += ' s-head';
            if (cell === 3) cls += ' s-food';
            html += `<div class="${cls}"></div>`;
        });
        
        html += '</div>';
        Sys.out.innerHTML = html;
    },

    endSnake: () => {
        clearInterval(State.snakeTimer);
        State.mode = 'SHELL';
        Sys.inputWrap.style.opacity = 1;
        Sys.input.focus();
        Sys.printCard("GAME OVER", `Final Score: <span class="c-accent">${State.snakeScore}</span>`);
    },

    // --- QUIZ & BLITZ ---
    startQuiz: (filter) => {
        let pool = Database.items;
        if(filter && filter.includes('#')) {
            const tag = filter.match(/#(\w+)/)[1];
            pool = pool.filter(i=>i.tags.includes(tag));
        }
        if(!pool.length) { Sys.print("No items.", "c-error"); return; }
        State.quizPool = pool;
        State.mode = 'QUIZ';
        Sys.nextQ();
    },

    startBlitz: () => {
        if(!Database.items.length) return;
        State.quizPool = Database.items;
        State.mode = 'BLITZ';
        State.blitzScore = 0;
        State.blitzEnd = Date.now() + 60000;
        Sys.printCard("BLITZ", "60 Seconds. Go!");
        State.blitzTimer = setInterval(() => { if(Date.now()>State.blitzEnd){clearInterval(State.blitzTimer);Sys.endBlitz();} }, 1000);
        Sys.nextQ();
    },

    nextQ: () => {
        const min = Math.min(...State.quizPool.map(i=>i.lvl));
        const cands = State.quizPool.filter(i=>i.lvl<=min+2);
        const item = cands[Math.floor(Math.random()*cands.length)];
        State.currentItem = item;
        let content;
        if(item.type==='vocab') {
            State.answerRaw = item.a;
            content = `<div style="font-size:16px; font-weight:bold">${item.q}</div>`;
        } else {
            const w = item.text.split(' ');
            let idx = w.findIndex(x=>x.length>3); if(idx<0) idx=0;
            State.answerRaw = w[idx].replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
            content = w.map((x,i)=>i===idx?"<span class='c-accent'>[___]</span>":x).join(' ');
        }
        let meta = item.streak > 1 ? ` <span style="color:#ff9000">üî• ${item.streak}</span>` : '';
        if(State.mode==='BLITZ') meta += ` <span style="float:right">${Math.ceil((State.blitzEnd-Date.now())/1000)}s</span>`;
        Sys.printCard(`QUESTION ${meta}`, content);
    },

    checkAnswer: (val) => {
        const raw = State.answerRaw;
        const seps = /[,Ôºå/„ÄÅ ]+/;
        const possible = raw.split(seps).map(s=>s.trim()).filter(s=>s);
        let ok = possible.some(p=>p===val.trim() || (p.length>1 && val.includes(p))) || raw.toLowerCase()===val.trim().toLowerCase();
        
        const item = State.currentItem;
        if(ok) {
            item.lvl++; item.streak++;
            if(State.mode==='BLITZ') State.blitzScore++;
            Sys.print(`‚úî Correct: ${raw}`, "c-success");
            setTimeout(()=>State.mode!=='SHELL' && Sys.nextQ(), 600);
        } else {
            item.lvl=0; item.streak=0;
            Sys.print(`‚úò Wrong: ${raw}`, "c-error");
            setTimeout(()=>State.mode!=='SHELL' && Sys.nextQ(), 2000);
        }
        Database.save(); Database.logActivity(); Sys.updateStatus();
    },

    endBlitz: () => { State.mode = 'SHELL'; Sys.printCard("TIME UP", `Score: <span class="c-accent" style="font-size:20px">${State.blitzScore}</span>`); },
    exitGame: () => { if(State.mode==='BLITZ') clearInterval(State.blitzTimer); State.mode = 'SHELL'; Sys.print("Exited.", "c-dim"); }
};

// --- CENTRAL KEY HANDLER ---
document.addEventListener('keydown', e => {
    // 1. GLOBAL ESCAPE
    if (e.key === 'Escape') {
        if (State.mode === 'MANAGE') { Sys.exitManage(); return; }
        if (State.mode === 'EDITING') { Sys.returnToManageNav(); return; }
        if (State.mode === 'QUIZ' || State.mode === 'BLITZ') { Sys.exitGame(); return; }
        if (State.mode === 'SNAKE') { Sys.endSnake(); return; }
    }

    // 2. SNAKE CONTROLS
    if (State.mode === 'SNAKE') {
        if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();
        if (e.key === 'ArrowUp' && State.direction !== 'DOWN') State.nextDirection = 'UP';
        if (e.key === 'ArrowDown' && State.direction !== 'UP') State.nextDirection = 'DOWN';
        if (e.key === 'ArrowLeft' && State.direction !== 'RIGHT') State.nextDirection = 'LEFT';
        if (e.key === 'ArrowRight' && State.direction !== 'LEFT') State.nextDirection = 'RIGHT';
        return;
    }

    // 3. MANAGE MODE
    if (State.mode === 'MANAGE') {
        e.preventDefault();
        if (e.key === 'ArrowUp' || e.key === 'Up') { State.manageIndex = (State.manageIndex - 1 + Database.items.length) % Database.items.length; Sys.renderManage(); }
        else if (e.key === 'ArrowDown' || e.key === 'Down') { State.manageIndex = (State.manageIndex + 1) % Database.items.length; Sys.renderManage(); }
        else if (e.key === 'Enter') { Sys.enterEditFromManage(); }
        else if (e.key === 'Backspace' || e.key === 'Delete') {
            if(confirm("Delete item?")) {
                Database.items.splice(State.manageIndex, 1);
                Database.save();
                if(!Database.items.length) Sys.exitManage();
                else { if(State.manageIndex>=Database.items.length) State.manageIndex--; Sys.renderManage(); Sys.updateStatus(); }
            }
        }
        return;
    }

    // 4. DEFAULT INPUT
    if (e.key === 'Enter' && State.mode !== 'MANAGE') {
        Sys.exec(Sys.input.value);
        if (State.mode !== 'EDITING') { Sys.input.value = ''; Sys.syncCursor(); }
    } else {
        if(document.activeElement !== Sys.input && e.key.length === 1 && !e.ctrlKey && !e.metaKey) Sys.input.focus();
    }
});

Sys.input.addEventListener('input', Sys.syncCursor);
Sys.fileLoader.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        try {
            const parsed = JSON.parse(evt.target.result);
            if (Array.isArray(parsed)) {
                Database.items = parsed; Database.save();
                Sys.print(`‚úî Loaded ${parsed.length} items.`, "c-success");
                Sys.updateStatus();
            }
        } catch(err) { Sys.print("Parse error.", "c-error"); }
    };
    reader.readAsText(file);
    Sys.fileLoader.value = '';
});

Sys.boot();
</script>
</body>
</html>
