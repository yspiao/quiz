<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUIZ // SYSTEM v9.4</title>
    <style>
        /* =========================================
           CORE THEME: NOIR & INTERACTIVE
           ========================================= */
        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --border: #1f1f1f;
            
            --text-main: #e5e5e5;
            --text-dim: #666;
            
            --accent: #d2a8ff; 
            --edit: #e3b341;
            
            --cursor-bg: #e5e5e5;
            --cursor-text: #000000;
            
            --font: "JetBrains Mono", "Menlo", "Consolas", monospace;
        }

        * { box-sizing: border-box; cursor: text; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg); 
            color: var(--text-main);
            font-family: var(--font); 
            font-size: 13px; 
            line-height: 1.6;
            overflow: hidden;
        }

        /* 1. Header */
        #header {
            position: fixed; top: 0; left: 0; width: 100%; height: 40px;
            background: rgba(0,0,0,0.9);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 20px;
            z-index: 100;
        }
        .logo-text { font-weight: 800; letter-spacing: 2px; color: var(--text-main); }

        /* 2. Main Terminal */
        #terminal {
            position: absolute; top: 40px; bottom: 0; left: 0; width: 100%;
            padding: 20px 20px 80px 20px;
            overflow-y: auto; z-index: 10;
        }
        .line { margin-bottom: 6px; white-space: pre-wrap; word-break: break-all; }
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 16px;
            margin: 8px 0 16px 0;
        }
        .card-header {
            font-size: 11px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 10px;
            border-bottom: 1px solid var(--border); padding-bottom: 5px;
        }

        /* 3. MANAGER UI */
        #manager-layer {
            position: absolute; top: 40px; bottom: 80px; left: 0; width: 100%;
            background: var(--bg);
            z-index: 50; display: none; overflow-y: auto; padding: 10px 0;
        }
        .list-row { padding: 4px 20px; color: var(--text-dim); cursor: pointer; display: flex; justify-content: space-between; }
        .list-row:hover { background: rgba(255,255,255,0.05); }
        .list-row.selected { background-color: var(--cursor-bg); color: var(--cursor-text); }
        .list-row.selected .c-dim, .list-row.selected .tag { color: #333 !important; }
        .list-content { white-space: pre; overflow: hidden; text-overflow: ellipsis; }

        /* 4. Input Area */
        #input-wrapper {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 16px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
            z-index: 200;
            display: flex; align-items: center;
            font-family: var(--font);
            font-size: 14px;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        #input-wrapper.editing { border-color: var(--edit); }

        #cmd-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; z-index: 2;
            padding: 10px 16px;
            font-family: inherit; font-size: inherit;
            caret-color: transparent;
        }

        #input-display {
            position: relative; z-index: 1;
            white-space: pre;
            pointer-events: none;
            display: flex;
            align-items: center;
            color: var(--text-main);
        }

        .cursor-block {
            display: inline-block;
            width: 8px; height: 1.2em;
            background: var(--accent);
            animation: blink 1s infinite;
            margin-left: 1px;
            vertical-align: text-bottom;
        }
        
        .cursor-block.edit-mode { background: var(--edit); }

        @keyframes blink { 50% { opacity: 0; } }

        /* Utils */
        .c-dim { color: var(--text-dim); }
        .c-accent { color: var(--accent); }
        .c-success { color: #3fb950; }
        .c-error { color: #f85149; }
        .tag { margin-left:8px; opacity:0.7; font-size:11px; }
        .heatmap-row { display: flex; gap: 3px; }
        .heat-cell { width:8px; height:8px; background:#222; border-radius:1px; }
        .heat-on { background: var(--accent); }
    </style>
</head>
<body>

<div id="header">
    <div id="quiz-logo" class="logo-text">....</div>
    <div style="flex:1"></div>
    <div id="status-bar" class="c-dim" style="font-size:11px;"></div>
</div>

<div id="terminal">
    <div id="output"></div>
</div>

<div id="manager-layer"></div>
<input type="file" id="file-loader" style="display:none" accept=".json">

<div id="input-wrapper">
    <input type="text" id="cmd-input" spellcheck="false" autocomplete="off">
    <div id="input-display">
        <span id="prompt-symbol" style="color:var(--text-dim); margin-right:10px">‚ùØ</span>
        <span id="input-mirror"></span><span id="cursor" class="cursor-block"></span>
    </div>
</div>

<script>
/**
 * QUIZ SYSTEM v9.4 // ROCK SOLID INPUT
 * Fix: Centralized Key Logic to prevent ESC/Enter failures
 */

const STORAGE_KEY = 'quiz_db_v9';
const ACTIVITY_KEY = 'quiz_act_v1';

const Database = {
    items: [], activity: {}, 
    load: function() {
        const d = localStorage.getItem(STORAGE_KEY);
        const a = localStorage.getItem(ACTIVITY_KEY);
        if (d) {
            this.items = JSON.parse(d);
            this.items.forEach(i => { if(!i.streak) i.streak = 0; if(!i.tags) i.tags = []; });
        }
        if (a) this.activity = JSON.parse(a);
    },
    save: function() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(this.items));
        localStorage.setItem(ACTIVITY_KEY, JSON.stringify(this.activity));
    },
    logActivity: function() {
        const k = new Date().toISOString().split('T')[0];
        this.activity[k] = (this.activity[k]||0) + 1;
        this.save();
    },
    getHeatmap: function() {
        const res = [];
        for(let i=4; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate()-i);
            const k = d.toISOString().split('T')[0];
            res.push(this.activity[k]||0);
        }
        return res;
    }
};

const State = {
    mode: 'SHELL', manageIndex: 0, editTargetIndex: null,
    quizPool: [], currentItem: null, answerRaw: null, 
    blitzScore: 0, blitzEnd: 0, blitzTimer: null
};

const Sys = {
    out: document.getElementById('output'),
    mgr: document.getElementById('manager-layer'),
    inputWrap: document.getElementById('input-wrapper'),
    input: document.getElementById('cmd-input'),
    mirror: document.getElementById('input-mirror'),
    cursor: document.getElementById('cursor'),
    logo: document.getElementById('quiz-logo'),
    statusBar: document.getElementById('status-bar'),
    fileLoader: document.getElementById('file-loader'),

    animateText: (el, txt) => {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ#%";
        let i = 0;
        const t = setInterval(() => {
            el.innerText = txt.split('').map((c,j) => j<i ? c : chars[Math.floor(Math.random()*chars.length)]).join('');
            if(i++ > txt.length) clearInterval(t);
        }, 30);
    },

    print: (html, type='line') => {
        const div = document.createElement('div');
        div.className = type==='card' ? 'card' : 'line';
        div.innerHTML = html;
        Sys.out.appendChild(div);
        Sys.out.scrollTop = Sys.out.scrollHeight;
    },

    printCard: (head, body) => Sys.print(`<div class="card-header">${head}</div><div>${body}</div>`, 'card'),

    updateStatus: () => {
        const xp = Database.items.reduce((a,b)=>a+(b.lvl||0), 0);
        const heat = Database.getHeatmap().map(v=>`<div class="heat-cell ${v>0?'heat-on':''}"></div>`).join('');
        Sys.statusBar.innerHTML = `<div style="display:flex; gap:10px; align-items:center;"><span>${Database.items.length} ITEMS</span> <span>${xp} XP</span> <div class="heatmap-row">${heat}</div></div>`;
    },

    boot: async () => {
        Sys.animateText(Sys.logo, "QUIZ");
        Database.load();
        await new Promise(r => setTimeout(r, 500));
        Sys.inputWrap.style.opacity = 1;
        Sys.input.focus();
        Sys.updateStatus();
        Sys.print("System Ready. Type <span class='c-accent'>list</span> to manage.", 'line');
    },

    exportFile: () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(Database.items, null, 2));
        const dl = document.createElement('a');
        dl.setAttribute("href", dataStr);
        dl.setAttribute("download", `quiz_backup_${new Date().toISOString().split('T')[0]}.json`);
        document.body.appendChild(dl); dl.click(); dl.remove();
        Sys.print("‚úî Export downloaded.", "c-success");
    },

    importFile: () => Sys.fileLoader.click(),

    // --- CENTRAL COMMAND EXECUTION ---
    exec: async (raw) => {
        const val = raw.trim();
        if(!val) return;

        // Routing based on mode (though Key Handler usually catches special modes first)
        if (State.mode === 'EDITING') { Sys.finishEdit(val); return; }
        if (State.mode === 'QUIZ' || State.mode === 'BLITZ') {
            if(['exit','quit','esc'].includes(val.toLowerCase())) { Sys.exitGame(); return; }
            Sys.checkAnswer(val);
            return;
        }

        Sys.print(`<span class="c-dim">‚ùØ</span> ${val}`);
        
        if (val.startsWith('+')) { Sys.addItem(val.substring(1)); return; }

        const [cmd, ...args] = val.split(' ');
        const argStr = args.join(' ');

        switch(cmd.toLowerCase()) {
            case 'list': case 'ls': case 'manage': Sys.enterManage(); break;
            case 'quiz': Sys.startQuiz(argStr); break;
            case 'blitz': Sys.startBlitz(); break;
            case 'help': 
                Sys.printCard("HELP", `
                    <span class="c-accent">list</span> : Manage (Edit/Del)<br>
                    <span class="c-accent">+ txt</span> : Quick Add<br>
                    <span class="c-accent">quiz</span> : Start Training<br>
                    <span class="c-accent">export</span> / <span class="c-accent">import</span> : Backup
                `);
                break;
            case 'export': Sys.exportFile(); break;
            case 'import': Sys.importFile(); break;
            case 'clear': Sys.out.innerHTML=''; break;
            default: Sys.print("Unknown command.", "c-error");
        }
    },

    addItem: (str) => {
        const tagRegex = /#(\w+)/g;
        const tags = (str.match(tagRegex)||[]).map(t=>t.substring(1));
        const clean = str.replace(tagRegex,'').trim();
        if(clean.includes('::')) {
            const [q,a] = clean.split('::').map(s=>s.trim());
            if(q&&a) Database.items.push({type:'vocab', q, a, tags, lvl:0, streak:0});
        } else {
            Database.items.push({type:'sentence', text:clean, tags, lvl:0, streak:0});
        }
        Database.logActivity();
        Sys.print("‚úî Saved.", "c-success");
        Sys.updateStatus();
    },

    // --- MANAGER MODE ---
    enterManage: () => {
        if(Database.items.length === 0) { Sys.print("Database empty.", "c-error"); return; }
        State.mode = 'MANAGE';
        State.manageIndex = 0;
        Sys.out.style.opacity = '0.1';
        Sys.mgr.style.display = 'block';
        
        // Disable input to prevent typing, but we handle keys globally
        Sys.input.value = '';
        Sys.mirror.innerText = '';
        Sys.input.disabled = true; 
        document.getElementById('input-display').style.opacity = 0.5;
        
        Sys.renderManage();
    },

    renderManage: () => {
        Sys.mgr.innerHTML = '';
        const header = document.createElement('div');
        header.style.padding = '0 20px 10px 20px';
        header.style.color = 'var(--accent)';
        header.innerText = "MANAGER // [Arrow] Move, [Enter] Edit, [Bksp] Del, [ESC] Back";
        Sys.mgr.appendChild(header);

        Database.items.forEach((item, i) => {
            const row = document.createElement('div');
            row.className = 'list-row ' + (i === State.manageIndex ? 'selected' : '');
            row.onclick = () => { State.manageIndex = i; Sys.renderManage(); };
            
            let txt = item.type === 'vocab' ? `${item.q} :: ${item.a}` : item.text;
            let tags = item.tags.map(t=>`#${t}`).join(' ');
            row.innerHTML = `<div class="list-content">${txt} <span class="tag">${tags}</span></div><div class="c-dim" style="font-size:10px">L${item.lvl}</div>`;
            Sys.mgr.appendChild(row);
        });
        const sel = Sys.mgr.children[State.manageIndex + 1];
        if(sel) sel.scrollIntoView({block:'nearest'});
    },

    exitManage: () => {
        State.mode = 'SHELL';
        Sys.mgr.style.display = 'none';
        Sys.out.style.opacity = '1';
        Sys.input.disabled = false;
        document.getElementById('input-display').style.opacity = 1;
        Sys.input.focus();
    },

    // --- EDITING ---
    enterEditFromManage: () => {
        State.mode = 'EDITING';
        State.editTargetIndex = State.manageIndex;
        const item = Database.items[State.manageIndex];
        let str = item.type==='vocab' ? `${item.q} :: ${item.a}` : item.text;
        if(item.tags.length) str += " " + item.tags.map(t=>`#${t}`).join(' ');

        // FORCE ENABLE and POPULATE immediately
        Sys.input.disabled = false;
        document.getElementById('input-display').style.opacity = 1;
        Sys.input.value = str;
        Sys.mirror.innerText = str; // Critical for visuals
        
        Sys.input.focus();
        Sys.cursor.classList.add('edit-mode');
        Sys.inputWrap.classList.add('editing');
    },

    finishEdit: (val) => {
        if(!val) { Sys.returnToManageNav(); return; }
        const item = Database.items[State.editTargetIndex];
        const tagRegex = /#(\w+)/g;
        const tags = (val.match(tagRegex)||[]).map(t=>t.substring(1));
        const clean = val.replace(tagRegex,'').trim();
        if(clean.includes('::')) {
            const [q,a] = clean.split('::').map(s=>s.trim());
            item.type = 'vocab'; item.q = q; item.a = a;
        } else { item.type = 'sentence'; item.text = clean; }
        item.tags = tags;
        Database.save();
        Sys.returnToManageNav();
    },

    returnToManageNav: () => {
        State.mode = 'MANAGE';
        Sys.input.value = '';
        Sys.mirror.innerText = '';
        Sys.input.disabled = true;
        document.getElementById('input-display').style.opacity = 0.5;
        Sys.cursor.classList.remove('edit-mode');
        Sys.inputWrap.classList.remove('editing');
        Sys.renderManage();
    },

    // --- QUIZ & BLITZ ---
    startQuiz: (filter) => {
        let pool = Database.items;
        if(filter && filter.includes('#')) {
            const tag = filter.match(/#(\w+)/)[1];
            pool = pool.filter(i=>i.tags.includes(tag));
        }
        if(!pool.length) { Sys.print("No items.", "c-error"); return; }
        State.quizPool = pool;
        State.mode = 'QUIZ';
        Sys.nextQ();
    },

    startBlitz: () => {
        if(!Database.items.length) return;
        State.quizPool = Database.items;
        State.mode = 'BLITZ';
        State.blitzScore = 0;
        State.blitzEnd = Date.now() + 60000;
        Sys.printCard("BLITZ", "60 Seconds. Go!");
        State.blitzTimer = setInterval(() => { if(Date.now()>State.blitzEnd){clearInterval(State.blitzTimer);Sys.endBlitz();} }, 1000);
        Sys.nextQ();
    },

    nextQ: () => {
        const min = Math.min(...State.quizPool.map(i=>i.lvl));
        const cands = State.quizPool.filter(i=>i.lvl<=min+2);
        const item = cands[Math.floor(Math.random()*cands.length)];
        State.currentItem = item;
        let content;
        if(item.type==='vocab') {
            State.answerRaw = item.a;
            content = `<div style="font-size:16px; font-weight:bold">${item.q}</div>`;
        } else {
            const w = item.text.split(' ');
            let idx = w.findIndex(x=>x.length>3); if(idx<0) idx=0;
            State.answerRaw = w[idx].replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
            content = w.map((x,i)=>i===idx?"<span class='c-accent'>[___]</span>":x).join(' ');
        }
        let meta = item.streak > 1 ? ` <span style="color:#ff9000">üî• ${item.streak}</span>` : '';
        if(State.mode==='BLITZ') meta += ` <span style="float:right">${Math.ceil((State.blitzEnd-Date.now())/1000)}s</span>`;
        Sys.printCard(`QUESTION ${meta}`, content);
    },

    checkAnswer: (val) => {
        const raw = State.answerRaw;
        const seps = /[,Ôºå/„ÄÅ ]+/;
        const possible = raw.split(seps).map(s=>s.trim()).filter(s=>s);
        let ok = possible.some(p=>p===val.trim() || (p.length>1 && val.includes(p))) || raw.toLowerCase()===val.trim().toLowerCase();
        
        const item = State.currentItem;
        if(ok) {
            item.lvl++; item.streak++;
            if(State.mode==='BLITZ') State.blitzScore++;
            Sys.print(`‚úî Correct: ${raw}`, "c-success");
            setTimeout(()=>State.mode!=='SHELL' && Sys.nextQ(), 600);
        } else {
            item.lvl=0; item.streak=0;
            Sys.print(`‚úò Wrong: ${raw}`, "c-error");
            setTimeout(()=>State.mode!=='SHELL' && Sys.nextQ(), 2000);
        }
        Database.save(); Database.logActivity(); Sys.updateStatus();
    },

    endBlitz: () => { State.mode = 'SHELL'; Sys.printCard("TIME UP", `Score: <span class="c-accent" style="font-size:20px">${State.blitzScore}</span>`); },
    exitGame: () => { if(State.mode==='BLITZ') clearInterval(State.blitzTimer); State.mode = 'SHELL'; Sys.print("Exited.", "c-dim"); }
};

// --- CENTRAL EVENT CONTROLLER (The Fix) ---

// 1. Unified Key Handler (Handles EVERYTHING)
document.addEventListener('keydown', e => {
    // A. GLOBAL ESCAPE HATCH
    if (e.key === 'Escape') {
        if (State.mode === 'MANAGE') { Sys.exitManage(); return; }
        if (State.mode === 'EDITING') { Sys.returnToManageNav(); return; }
        if (State.mode === 'QUIZ' || State.mode === 'BLITZ') { Sys.exitGame(); return; }
    }

    // B. MANAGE MODE KEYS (Intercept before input focus)
    if (State.mode === 'MANAGE') {
        e.preventDefault(); // Stop scroll
        if (e.key === 'ArrowUp' || e.key === 'Up') {
            State.manageIndex = (State.manageIndex - 1 + Database.items.length) % Database.items.length;
            Sys.renderManage();
        } 
        else if (e.key === 'ArrowDown' || e.key === 'Down') {
            State.manageIndex = (State.manageIndex + 1) % Database.items.length;
            Sys.renderManage();
        }
        else if (e.key === 'Enter') { Sys.enterEditFromManage(); }
        else if (e.key === 'Backspace' || e.key === 'Delete') {
            if(confirm("Delete this item?")) {
                Database.items.splice(State.manageIndex, 1);
                Database.save();
                if(Database.items.length === 0) Sys.exitManage();
                else {
                    if(State.manageIndex >= Database.items.length) State.manageIndex--;
                    Sys.renderManage();
                    Sys.updateStatus();
                }
            }
        }
        return; // Don't let other logic run
    }

    // C. EDITING MODE KEYS
    if (State.mode === 'EDITING') {
        if (e.key === 'Enter') {
            Sys.finishEdit(Sys.input.value);
        }
        return; // Let native input handling work for other keys
    }

    // D. SHELL/QUIZ KEYS (Default behavior + Focus Logic)
    if (e.key === 'Enter') {
        Sys.exec(Sys.input.value);
        Sys.input.value = ''; 
        Sys.mirror.innerText = '';
    } else {
        // Auto-focus if typing normally
        if(document.activeElement !== Sys.input && e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
            Sys.input.focus();
        }
    }
});

// 2. Mirror Input Visuals
Sys.input.addEventListener('input', () => Sys.mirror.innerText = Sys.input.value);

// 3. File Loader
Sys.fileLoader.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        try {
            const parsed = JSON.parse(evt.target.result);
            if (Array.isArray(parsed)) {
                Database.items = parsed; Database.save();
                Sys.print(`‚úî Loaded ${parsed.length} items.`, "c-success");
                Sys.updateStatus();
            }
        } catch(err) { Sys.print("Parse error.", "c-error"); }
    };
    reader.readAsText(file);
    Sys.fileLoader.value = '';
});

Sys.boot();
</script>
</body>
</html>